from flask import Flask, request, render_template, redirect, url_for, g
import sqlite3

app = Flask(__name__)

DATABASE = 'dishes.db'

def get_db():
    db = getattr(g, '_database', None)
    if db is None:
        db = g._database = sqlite3.connect(DATABASE)
    return db

@app.teardown_appcontext
def close_connection(exception):
    db = getattr(g, '_database', None)
    if db is not None:
        db.close()

def init_db():
    with app.app_context():
        db = get_db()
        c = db.cursor()
        c.execute('''CREATE TABLE IF NOT EXISTS dishes
                     (id INTEGER PRIMARY KEY, name TEXT, price REAL, password TEXT)''')
        db.commit()

@app.route('/')
def index():
    db = get_db()
    c = db.cursor()
    c.execute("SELECT id, name, price FROM dishes")
    dishes = c.fetchall()
    return render_template('index.html', dishes=dishes)

@app.route('/add', methods=['POST'])
def add_dish():
    name = request.form['name']
    price = request.form['price']
    password = request.form['password']
    
    if not name or not price or not password:
        return redirect(url_for('index'))  # Redirect if fields are missing

    try:
        price = float(price)  # Ensure price is a valid number
        db = get_db()
        c = db.cursor()
        c.execute("INSERT INTO dishes (name, price, password) VALUES (?, ?, ?)", (name, price, password))
        db.commit()
    except ValueError:
        pass  # Ignore invalid price values

    return redirect(url_for('index'))

@app.route('/remove', methods=['POST'])
def remove_dish():
    dish_id = request.form['id']
    password = request.form['password']

    db = get_db()
    c = db.cursor()
    c.execute("SELECT password FROM dishes WHERE id=?", (dish_id,))
    stored_password = c.fetchone()

    if stored_password and stored_password[0] == password:
        c.execute("DELETE FROM dishes WHERE id=?", (dish_id,))
        db.commit()

    return redirect(url_for('index'))

@app.route('/template')
def template():
    return '''
    <!DOCTYPE html>
    <html>
    <head>
        <title>Dish List</title>
    </head>
    <body>
        <h1>Add a Dish</h1>
        <form action="/add" method="post">
            <label for="name">Dish Name:</label>
            <input type="text" id="name" name="name" required><br><br>
            <label for="price">Price:</label>
            <input type="text" id="price" name="price" required><br><br>
            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required><br><br>
            <input type="submit" value="Add Dish">
        </form>
        <h1>Available Dishes</h1>
        <ul>
            {% for dish in dishes %}
            <li>{{ dish[1] }} - ${{ dish[2] }}
                <form action="/remove" method="post" style="display:inline;">
                    <input type="hidden" name="id" value="{{ dish[0] }}">
                    <input type="password" name="password" placeholder="Enter password to remove">
                    <input type="submit" value="Remove">
                </form>
            </li>
            {% endfor %}
        </ul>
    </body>
    </html>
    '''

if __name__ == '__main__':
    init_db()
    app.run(debug=True)
